<html>

<head>
    <title>Final Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        #tblCalendar tr td {
            border: 1px solid #000000;
            border-collapse: collapse;
            padding: 3px;
        }
    </style>
    <script src="js/jquery-2.2.2.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.11.4.custom/jquery-ui.theme.css" />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <script>
        $(document).ready(function () {
            $tbl = $('#tblCalendar');
            $tbl.css('table-layout', 'fixed');
            $.getJSON("js/form.json", function (data) {
                $.getJSON("js/caldata.json", function (calendarData) {
                    var timeLineWidth;
                    var topicsHeight;
                    console.log(calendarData);
                    //console.log(data);
                    $tr = $('<tr></tr>');
                    
                    //Top left corner, empty box
                    $tr.append($('<th id="corner" class="ui-widget-header">&nbsp;</th>'));

                    //Constructs columns, adds timeline values
                    for (var j = 0; j < data.timeline.length; j++) {
                        $th = $('<th class="ui-widget-header"></th>');
                        $th.html('<strong>' + data.timeline[j].timeItemLabel + '</strong>');
                        timelineWidth = 1024/data.timeline.length;
                        $th.attr('style', 'width:'+ timelineWidth +'px;');
                        $tr.append($th);
                    }
                    $tbl.append($tr);

                    //Populate the topics rows
                    for (var i = 0; i < data.topics.length; i++) {
                        //console.log("Row label value: " + data.topics[i].topicLabel);
                        $tr = $('<tr>"></tr>');
                        $tdTopic = $('<td></td>');
                        $tdTopic.attr('id', i);
                        $tdTopic.html(data.topics[i].topicLabel);
                        
                        $tdTopic.attr('style', 'width:65px;')
                        $tr.append($tdTopic);
                        
                        //Add boxes and text areas in each row equal to number of columns
                        for (var j = 0; j < data.timeline.length; j++) {
                            $td = $('<td></td>');
                            $td.attr('id', 'td_' + data.topics[i].topicID + '_' + data.timeline[j].timeItemID);
                            //$td.attr('style', 'height:100%;width:'+ timelineWidth+';resize:none;;');
                            
                            $txt = $('<textarea></textarea>');
                            
                            $txt.val(getCalendarDataValue(calendarData, data.topics[i].topicID, data.timeline[j].timeItemID));
                            $txt.attr('id', 'txt_' + data.topics[i].topicID + '_' + data.timeline[j].timeItemID);
                                                        
                            //$txt.attr('style', 'height:100%;width:100%;resize:none;border:none;');

                            $txt.focusout(function (evt) {
                                $obj = $('#' + evt.target.id);
                                saveItemData($obj.attr('id'), $obj.val());
                            });
                            $txt.css('display', 'none');
                            $div = $('<div></div>');
                            $div.attr('id', 'div_' + data.topics[i].topicID + '_' + data.timeline[j].timeItemID);
                            timelineWidth = 1024/(data.timeline.length + 2);
                            topicsHeight = 768/(data.topics.length + 1);
                            $div.attr('style', 'height:'+ topicsHeight + ';width:'+ timelineWidth+';');
                            //$div.css('display', 'none');
                            
                            $div.html(getCalendarDataValue(calendarData, data.topics[i].topicID, data.timeline[j].timeItemID));
                            $div.click(function (evt) {
                                console.log("clicked");
                                displayEditableText(evt.target.id);
                            });
                            //console.log($div);
                            $td.append($div);
                            $td.append($txt);                        
                            $tr.append($td);
                        }
                        $tbl.append($tr);
                    }
                    //Submit button
                    $('#corner').append($('<input id="btnSubmit" type="button" value="Submit Form">'));

                    //convert textareas to strings
                    $('#btnSubmit').click(function () {
                        $('#tblCalendar tr').each(function () {
                            $('td', this).each(function () {
                                var value = $(this).find('input, select, textarea').val();
                                $(this).find('input, select, textarea').val('');
                                $(this).html(value);
                                console.log(value);
                            });
                        });
                    });

                    function saveItemData(controlID, val) {
                        var topicID, timeItemID;
                        var idArray = controlID.split('_');
                        var dataToSave = {};

                        if (val !== "") {
                            if (idArray.length == 3) {
                                topicID = idArray[1];
                                timeItemID = idArray[2];

                                dataToSave.topicID = topicID;
                                dataToSave.timeItemID = timeItemID;
                                dataToSave.textValue = val;

                                console.log(dataToSave);
                                //$.post('savecalendarentry.php', dataToSave);
                            }
                        }
                    };


                });
                

                function getCalendarDataValue(calData, topicID, timeItemID) {
                    for (var k = 0; k < calData.caldata.length; k++) {
                        if (calData.caldata[k].topicID == topicID && calData.caldata[k].timeItemID == timeItemID) {
                            return calData.caldata[k].textValue;
                        }
                    }
                };


                function displayEditableText(controlID) {
                    var idArray = controlID.split('_');
                    timelineWidth = 1024/(data.timeline.length + 2);
                    
                    if (idArray.length == 3) {
                        topicID = idArray[1];
                        timeItemID = idArray[2];

                        $div = $('#div_' + topicID + '_' + timeItemID);
                        $txt = $('#txt_' + topicID + '_' + timeItemID);
                        
                        $txt.attr('style', 'height:100%;width:'+ timelineWidth+';resize:none;border:none;');
                        $div.css('display', 'none');
                        $txt.css('display', 'block');
                    }else{
                        $txt.attr('style', 'height:100%;width:'+ timelineWidth+';resize:none;border:none;');    
                        $div.css('display', 'none');
                        $txt.css('display', 'block');
                    }
                }
            });
        });
    </script>
</head>

<body>
    <table id="tblCalendar" border="1" class="ui-widget">
        <tbody class="ui-widget-content">
            <tr></tr>
        </tbody>
    </table>


</body>

</html>